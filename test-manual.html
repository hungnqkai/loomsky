<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoomSky Data Debug Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .results {
            padding: 20px;
        }
        .result-section {
            margin-bottom: 30px;
        }
        .result-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .test-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .test-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .sample-elements {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 5px;
        }
        .sample-elements h3 {
            margin-top: 0;
            color: #2c5aa0;
        }
        .element-group {
            margin-bottom: 15px;
        }
        .element-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .element-group input, .element-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="header">
            <h1>üîç LoomSky Data Debug Tool</h1>
            <p>Test and inspect data collection on any website</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="testFullDataCollection()">üîÑ Test Data Collection</button>
            <button class="btn" onclick="testPerformanceMetrics()">üìä Performance Metrics</button>
            <button class="btn" onclick="inspectCurrentData()">üëÅÔ∏è Inspect Current Data</button>
            <button class="btn" onclick="triggerPageView()">üìÑ Trigger PageView</button>
            <button class="btn" onclick="triggerCustomEvent()">‚ö° Trigger Custom Event</button>
            <button class="btn danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>

        <div class="controls">
            <div class="test-form">
                <label>Test Selector:</label>
                <input type="text" id="selectorInput" class="test-input" placeholder="e.g., #price, .product-name, input[name='email']" value="#price">
                <button class="btn" onclick="testSelector()">Test Selector</button>
            </div>
        </div>

        <div class="results">
            <div class="result-section">
                <div class="result-title">
                    <span id="statusIndicator" class="status-indicator status-warning"></span>
                    SDK Status
                </div>
                <div id="sdkStatus" class="json-display">SDK not detected or not loaded</div>
            </div>

            <div class="result-section">
                <div class="result-title">Debug Results</div>
                <div id="debugResults" class="json-display">Click any button above to start testing...</div>
            </div>

            <div class="result-section">
                <div class="result-title">Console Logs</div>
                <div id="consoleLogs" class="log-container">Console logs will appear here...</div>
            </div>
        </div>

        <!-- Sample elements for testing -->
        <div class="sample-elements">
            <h3>Sample Elements for Testing</h3>
            <div class="element-group">
                <label for="testPrice">Product Price:</label>
                <input type="text" id="price" name="price" value="$29.99">
            </div>
            <div class="element-group">
                <label for="testEmail">User Email:</label>
                <input type="email" id="email" name="email" value="test@example.com">
            </div>
            <div class="element-group">
                <label for="testCategory">Category:</label>
                <select id="category" name="category">
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing</option>
                    <option value="books">Books</option>
                </select>
            </div>
            <div class="element-group">
                <label>Product Name:</label>
                <span id="product-name" class="product-title">LoomSky Pro Analytics</span>
            </div>
        </div>
    </div>

    <script>
        // Console log capture
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const logs = [];

        function captureLog(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = Array.from(args).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateConsoleLogs();
        }

        console.log = function(...args) {
            captureLog('log', args);
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            captureLog('error', args);
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            captureLog('warn', args);
            originalWarn.apply(console, args);
        };

        function updateConsoleLogs() {
            const container = document.getElementById('consoleLogs');
            container.textContent = logs.slice(-20).join('\n'); // Show last 20 logs
            container.scrollTop = container.scrollHeight;
        }

        function checkSDKStatus() {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('sdkStatus');
            
            if (typeof window.LoomSkySDK !== 'undefined') {
                indicator.className = 'status-indicator status-ok';
                status.textContent = 'SDK loaded and ready ‚úÖ';
                return true;
            } else if (typeof window.loomskyEventListener !== 'undefined') {
                indicator.className = 'status-indicator status-ok';
                status.textContent = 'SDK components detected ‚úÖ';
                return true;
            } else {
                indicator.className = 'status-indicator status-error';
                status.textContent = 'SDK not detected ‚ùå\nMake sure LoomSky SDK is loaded on this page';
                return false;
            }
        }

        function displayResult(data) {
            const container = document.getElementById('debugResults');
            container.textContent = JSON.stringify(data, null, 2);
        }

        function testFullDataCollection() {
            if (!checkSDKStatus()) return;
            
            try {
                if (window.LoomSkySDK && window.LoomSkySDK.testDataCollection) {
                    const result = window.LoomSkySDK.testDataCollection();
                    displayResult({
                        test: 'Full Data Collection',
                        timestamp: new Date().toISOString(),
                        result: result
                    });
                } else {
                    displayResult({
                        error: 'testDataCollection method not available',
                        available_methods: Object.keys(window.LoomSkySDK || {})
                    });
                }
            } catch (error) {
                displayResult({
                    test: 'Full Data Collection',
                    error: error.message,
                    stack: error.stack
                });
            }
        }

        function testPerformanceMetrics() {
            if (!checkSDKStatus()) return;
            
            try {
                if (window.LoomSkySDK && window.LoomSkySDK.getPerformanceMetrics) {
                    const result = window.LoomSkySDK.getPerformanceMetrics();
                    displayResult({
                        test: 'Performance Metrics',
                        timestamp: new Date().toISOString(),
                        result: result
                    });
                } else {
                    displayResult({
                        error: 'getPerformanceMetrics method not available'
                    });
                }
            } catch (error) {
                displayResult({
                    test: 'Performance Metrics',
                    error: error.message
                });
            }
        }

        function testSelector() {
            const selector = document.getElementById('selectorInput').value;
            if (!selector) {
                alert('Please enter a CSS selector');
                return;
            }

            if (!checkSDKStatus()) return;

            try {
                if (window.LoomSkySDK && window.LoomSkySDK.testSelector) {
                    const result = window.LoomSkySDK.testSelector(selector);
                    displayResult({
                        test: 'Selector Test',
                        selector: selector,
                        timestamp: new Date().toISOString(),
                        result: result
                    });
                } else {
                    // Fallback manual test
                    try {
                        const elements = document.querySelectorAll(selector);
                        const values = Array.from(elements).slice(0, 3).map(el => {
                            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(el.tagName)) {
                                return el.value;
                            }
                            return el.innerText || el.textContent;
                        });
                        
                        displayResult({
                            test: 'Manual Selector Test',
                            selector: selector,
                            result: {
                                valid: true,
                                elements_found: elements.length,
                                sample_values: values
                            }
                        });
                    } catch (error) {
                        displayResult({
                            test: 'Manual Selector Test',
                            selector: selector,
                            result: {
                                valid: false,
                                error: error.message
                            }
                        });
                    }
                }
            } catch (error) {
                displayResult({
                    test: 'Selector Test',
                    selector: selector,
                    error: error.message
                });
            }
        }

        function inspectCurrentData() {
            const currentData = {
                page: {
                    url: window.location.href,
                    title: document.title,
                    referrer: document.referrer,
                    timestamp: new Date().toISOString()
                },
                cookies: {
                    ls_user_id: getCookie('ls_user_id'),
                    ls_session_id: getCookie('ls_session_id'),
                    _fbp: getCookie('_fbp'),
                    _fbc: getCookie('_fbc')
                },
                dataLayer: window.loomskyDataLayer || null,
                sdk: {
                    loaded: typeof window.LoomSkySDK !== 'undefined',
                    methods: window.LoomSkySDK ? Object.keys(window.LoomSkySDK) : []
                }
            };

            displayResult({
                test: 'Current Data Inspection',
                timestamp: new Date().toISOString(),
                result: currentData
            });
        }

        function triggerPageView() {
            if (!checkSDKStatus()) return;

            try {
                if (window.LoomSkySDK && window.LoomSkySDK.handleEvent) {
                    window.LoomSkySDK.handleEvent('PageView', {
                        debug: true,
                        triggered_by: 'debug_tool'
                    });
                    displayResult({
                        test: 'PageView Event Triggered',
                        timestamp: new Date().toISOString(),
                        message: 'Check console logs for event processing details'
                    });
                } else {
                    displayResult({
                        error: 'handleEvent method not available'
                    });
                }
            } catch (error) {
                displayResult({
                    test: 'PageView Event',
                    error: error.message
                });
            }
        }

        function triggerCustomEvent() {
            const eventData = {
                event_name: 'DebugTest',
                debug: true,
                test_data: {
                    price: document.getElementById('price').value,
                    email: document.getElementById('email').value,
                    category: document.getElementById('category').value
                }
            };

            if (!checkSDKStatus()) return;

            try {
                if (window.LoomSkySDK && window.LoomSkySDK.handleEvent) {
                    window.LoomSkySDK.handleEvent('CustomEvent', eventData);
                    displayResult({
                        test: 'Custom Event Triggered',
                        timestamp: new Date().toISOString(),
                        event_data: eventData,
                        message: 'Check console logs for event processing details'
                    });
                } else {
                    displayResult({
                        error: 'handleEvent method not available'
                    });
                }
            } catch (error) {
                displayResult({
                    test: 'Custom Event',
                    error: error.message
                });
            }
        }

        function clearResults() {
            document.getElementById('debugResults').textContent = 'Results cleared...';
            logs.length = 0;
            updateConsoleLogs();
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSDKStatus();
            
            // Auto-refresh SDK status every 2 seconds
            setInterval(checkSDKStatus, 2000);
        });

        // Test data layer simulation
        window.loomskyDataLayer = {
            platform: 'debug-tool',
            page_type: 'test',
            user: {
                is_logged_in: false,
                user_id: null
            },
            debug: true
        };
    </script>

    <script async src="http://localhost:5173/dist/loomsky-sdk.iife.js" data-api-key="ls_key_8cd96846791bc40d84378da589cffba1"></script>
</body>
</html>